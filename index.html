<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Profit Calculator</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="192x192" href="favicon-192.png">
    <script>
        // Tailwind CSS configuration - must be before loading Tailwind
        window.tailwindConfig = {
            darkMode: 'class'
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes digitChange {
            0% {
                opacity: 0.5;
                transform: scale(0.95);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.05);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .animate-digit {
            animation: digitChange 0.3s ease-in-out;
        }

        /* Smooth slide-down animation for results */
        #results {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: max-height 0.5s ease-out, opacity 0.3s ease-out;
        }

        #results.show {
            max-height: 500px;
            opacity: 1;
        }

        /* Individual digit animation */
        @keyframes digitFlip {
            0% {
                transform: rotateX(0deg);
                opacity: 1;
            }
            50% {
                transform: rotateX(90deg);
                opacity: 0.5;
            }
            100% {
                transform: rotateX(0deg);
                opacity: 1;
            }
        }

        .digit-flip {
            display: inline-block;
            animation: digitFlip 0.4s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen py-8 px-4 transition-colors duration-200">
    <div class="max-w-2xl mx-auto">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 md:p-8">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800 dark:text-white">Crypto Profit Calculator</h1>
                <button 
                    id="darkModeToggle" 
                    class="p-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"
                    title="Toggle dark mode"
                >
                    <svg id="sunIcon" class="w-6 h-6 text-yellow-500 hidden" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"></path>
                    </svg>
                    <svg id="moonIcon" class="w-6 h-6 text-gray-700 dark:text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                    </svg>
                </button>
            </div>
            
            <form id="calcForm" class="space-y-4">
                <div>
                    <label for="investment" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Investment Amount
                    </label>
                    <input 
                        type="number" 
                        id="investment" 
                        step="0.01"
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                        placeholder="Enter investment amount"
                    />
                </div>

                <div>
                    <label for="buyPrice" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Buy Price
                    </label>
                    <input 
                        type="number" 
                        id="buyPrice" 
                        step="0.01"
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                        placeholder="Enter buy price"
                    />
                </div>

                <div>
                    <label for="sellPrice" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Sell Price
                    </label>
                    <div class="flex gap-2">
                        <input 
                            type="number" 
                            id="sellPrice" 
                            step="0.01"
                            class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                            placeholder="Enter sell price"
                        />
                        <button
                            type="button"
                            id="refreshPrice"
                            class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-md transition"
                            title="Refresh current BTC price"
                        >
                            ðŸ”„
                        </button>
                    </div>
                </div>

                <div>
                    <label for="fee" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Fee (%)
                    </label>
                    <input 
                        type="number" 
                        id="fee" 
                        step="0.001"
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                        placeholder="Enter fee percentage"
                    />
                </div>

                <div>
                    <label for="currency" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Currency
                    </label>
                    <select 
                        id="currency" 
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                    >
                        <option value="USD">USD - US Dollar</option>
                        <option value="EUR">EUR - Euro</option>
                        <option value="GBP">GBP - British Pound</option>
                        <option value="JPY">JPY - Japanese Yen</option>
                        <option value="CNY">CNY - Chinese Yuan</option>
                        <option value="AUD">AUD - Australian Dollar</option>
                        <option value="CAD">CAD - Canadian Dollar</option>
                        <option value="CHF">CHF - Swiss Franc</option>
                        <option value="INR">INR - Indian Rupee</option>
                        <option value="BRL">BRL - Brazilian Real</option>
                        <option value="RUB">RUB - Russian Ruble</option>
                        <option value="RON">RON - Romanian Leu</option>
                        <option value="KRW">KRW - South Korean Won</option>
                        <option value="MXN">MXN - Mexican Peso</option>
                        <option value="SGD">SGD - Singapore Dollar</option>
                        <option value="HKD">HKD - Hong Kong Dollar</option>
                    </select>
                </div>

                <button 
                    type="submit" 
                    class="w-full bg-blue-600 text-white py-3 rounded-md hover:bg-blue-700 transition font-semibold"
                >
                    Calculate
                </button>
            </form>

            <div id="results" class="mt-6">
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 space-y-3">
                    <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-3">Results</h2>
                    
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600 dark:text-gray-400">Coins Purchased:</span>
                            <span id="coinsPurchased" class="font-semibold dark:text-white"></span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600 dark:text-gray-400">Buy Fee:</span>
                            <span id="buyFee" class="font-semibold text-red-600 dark:text-red-400"></span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600 dark:text-gray-400">Gross Sale Amount:</span>
                            <span id="grossSale" class="font-semibold dark:text-white"></span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600 dark:text-gray-400">Sell Fee:</span>
                            <span id="sellFee" class="font-semibold text-red-600 dark:text-red-400"></span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600 dark:text-gray-400">Net Sale Amount:</span>
                            <span id="netSale" class="font-semibold dark:text-white"></span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600 dark:text-gray-400">Total Fees:</span>
                            <span id="totalFees" class="font-semibold text-red-600 dark:text-red-400"></span>
                        </div>
                        
                        <div class="border-t dark:border-gray-600 pt-3 mt-3">
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-bold text-gray-800 dark:text-white">Net Profit/Loss:</span>
                                <span id="netProfit" class="text-2xl font-bold"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dark mode management
        function initDarkMode() {
            const darkModeToggle = document.getElementById('darkModeToggle');
            const sunIcon = document.getElementById('sunIcon');
            const moonIcon = document.getElementById('moonIcon');
            const html = document.documentElement;
            
            // Check for saved dark mode preference, default to light mode
            const savedDarkMode = getCookie('crypto_calc_darkMode');
            const isDarkMode = savedDarkMode === 'true';
            
            // Apply dark mode if saved
            if (isDarkMode) {
                html.classList.add('dark');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }
            
            // Toggle dark mode
            darkModeToggle.addEventListener('click', function() {
                const isDark = html.classList.toggle('dark');
                setCookie('crypto_calc_darkMode', isDark.toString(), 365);
                
                // Toggle icons
                if (isDark) {
                    sunIcon.classList.remove('hidden');
                    moonIcon.classList.add('hidden');
                } else {
                    sunIcon.classList.add('hidden');
                    moonIcon.classList.remove('hidden');
                }
            });
        }

        // Animation configuration
        const ANIMATION_CONFIG = {
            DIGIT_FLIP_DURATION: 400, // ms - matches CSS animation duration
            DIGIT_STAGGER_DELAY: 30,  // ms - delay between each digit
            RESULTS_SLIDE_DURATION: 500 // ms - results container slide-down
        };

        // Default values
        const defaults = {
            investment: 50000,
            buyPrice: 480000,
            sellPrice: null, // Will be fetched from API
            sellPriceFallback: 485000, // Fallback only if API fails (approximate USD value)
            fee: 0.01
        };

        // State to track if results have been shown
        let resultsShown = false;

        // Fetch current BTC price from CoinGecko API via Cloudflare Worker proxy with fallback
        async function fetchBTCPrice(currency = 'usd') {
            const currencyLower = currency.toLowerCase();
            
            // Try worker first
            try {
                // TODO: Replace this URL with your deployed Cloudflare Worker URL
                // Example: https://crypto-cache.YOUR_SUBDOMAIN.workers.dev/api/v3/simple/price?ids=bitcoin&vs_currencies=${currencyLower}
                const workerUrl = `https://crypto-cache.tbog.workers.dev/api/v3/simple/price?ids=bitcoin&vs_currencies=${currencyLower}`;
                const response = await fetch(workerUrl);
                
                if (!response.ok) {
                    throw new Error(`Worker responded with status ${response.status}`);
                }
                
                const data = await response.json();
                return data.bitcoin[currencyLower];
            } catch (workerError) {
                console.warn('Worker API failed, falling back to public API:', workerError);
                
                // Fallback to public CoinGecko API
                try {
                    const publicUrl = `https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=${currencyLower}`;
                    const response = await fetch(publicUrl);
                    
                    if (!response.ok) {
                        throw new Error(`Public API responded with status ${response.status}`);
                    }
                    
                    const data = await response.json();
                    return data.bitcoin[currencyLower];
                } catch (publicError) {
                    console.error('Both worker and public API failed:', publicError);
                    // Return null to allow downstream code to decide fallback behavior
                    // User can still manually enter a sell price if API is unavailable
                    return null;
                }
            }
        }

        // Cookie helper functions
        function setCookie(name, value, days = 90) {
            const expires = new Date();
            expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000);
            document.cookie = name + '=' + encodeURIComponent(value) + ';expires=' + expires.toUTCString() + ';path=/';
        }

        function getCookie(name) {
            const nameEQ = name + '=';
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return decodeURIComponent(c.substring(nameEQ.length, c.length));
            }
            return null;
        }

        // Detect user's currency based on locale
        function detectUserCurrency() {
            try {
                // Try to detect currency from user's locale
                const userLocale = navigator.language || navigator.userLanguage || 'en-US';
                
                // Common currency mappings based on locale
                const localeToCurrency = {
                    'en-US': 'USD', 'en-GB': 'GBP', 'en-AU': 'AUD', 'en-CA': 'CAD',
                    'de': 'EUR', 'de-DE': 'EUR', 'fr': 'EUR', 'fr-FR': 'EUR', 
                    'es': 'EUR', 'es-ES': 'EUR', 'it': 'EUR', 'it-IT': 'EUR',
                    'pt-BR': 'BRL', 'ja': 'JPY', 'ja-JP': 'JPY',
                    'zh-CN': 'CNY', 'ko': 'KRW', 'ko-KR': 'KRW',
                    'en-IN': 'INR', 'hi': 'INR', 'ru': 'RUB', 'ru-RU': 'RUB',
                    'ro': 'RON', 'ro-RO': 'RON',
                    'es-MX': 'MXN', 'en-SG': 'SGD', 'zh-HK': 'HKD', 'en-HK': 'HKD'
                };
                
                // Try exact match first, then language part
                let detectedCurrency = localeToCurrency[userLocale];
                if (!detectedCurrency) {
                    const lang = userLocale.split('-')[0];
                    detectedCurrency = localeToCurrency[lang];
                }
                
                return detectedCurrency || 'USD';
            } catch (e) {
                return 'USD';
            }
        }

        // Save form values to cookies (excluding sell price)
        function saveFormValues() {
            setCookie('crypto_calc_investment', document.getElementById('investment').value);
            setCookie('crypto_calc_buyPrice', document.getElementById('buyPrice').value);
            // Sell price is not saved - always fetched from API
            setCookie('crypto_calc_fee', document.getElementById('fee').value);
            setCookie('crypto_calc_currency', document.getElementById('currency').value);
        }

        // Load form values from cookies
        async function loadFormValues() {
            const savedInvestment = getCookie('crypto_calc_investment');
            const savedBuyPrice = getCookie('crypto_calc_buyPrice');
            // Sell price is not saved in cookies - always fetch from API
            const savedFee = getCookie('crypto_calc_fee');
            const savedCurrency = getCookie('crypto_calc_currency');

            // Set currency first: try cookie, then detect, then default to USD
            const currency = savedCurrency ?? detectUserCurrency();
            document.getElementById('currency').value = currency;

            // Fetch current BTC price for the selected currency
            const sellPriceValue = await fetchBTCPrice(currency);

            // Set values from cookies or defaults
            document.getElementById('investment').value = savedInvestment ?? defaults.investment;
            document.getElementById('buyPrice').value = savedBuyPrice ?? defaults.buyPrice;
            // Use fetched price, or fallback to approximate value for initial load only
            document.getElementById('sellPrice').value = sellPriceValue ?? defaults.sellPriceFallback;
            document.getElementById('fee').value = savedFee ?? defaults.fee;
        }

        // Set default values
        function setDefaults() {
            document.getElementById('investment').value = defaults.investment;
            document.getElementById('buyPrice').value = defaults.buyPrice;
            document.getElementById('sellPrice').value = defaults.sellPriceFallback;
            document.getElementById('fee').value = defaults.fee;
        }

        // Format number as currency
        function formatCurrency(num) {
            const currency = document.getElementById('currency').value || 'USD';
            // Use 'en-US' locale for consistent formatting across all users
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: currency,
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(num);
        }

        // Animate element when value changes
        function animateElement(element) {
            element.classList.remove('animate-digit');
            // Force reflow to restart animation
            void element.offsetWidth;
            element.classList.add('animate-digit');
        }

        // Animate individual characters/digits with staggered effect
        function animateDigits(element, newValue) {
            const oldValue = element.textContent;
            if (oldValue === newValue) return;

            // Wrap each character in a span for individual animation
            const chars = newValue.split('');
            element.innerHTML = chars.map((char, index) => {
                const delayMs = index * ANIMATION_CONFIG.DIGIT_STAGGER_DELAY;
                return `<span class="digit-flip" style="animation-delay: ${delayMs}ms">${char}</span>`;
            }).join('');

            // Remove animation classes after animation completes
            const totalDuration = ANIMATION_CONFIG.DIGIT_FLIP_DURATION + (chars.length * ANIMATION_CONFIG.DIGIT_STAGGER_DELAY);
            setTimeout(() => {
                element.textContent = newValue;
            }, totalDuration);
        }

        // Update element with animation
        function updateWithAnimation(elementId, value) {
            const element = document.getElementById(elementId);
            if (resultsShown) {
                animateDigits(element, value);
            } else {
                element.textContent = value;
            }
        }

        // Check if results are currently visible
        function areResultsVisible() {
            const resultsElement = document.getElementById('results');
            return resultsElement && resultsElement.classList.contains('show');
        }

        // Calculate profit
        function calculate() {
            const investment = parseFloat(document.getElementById('investment').value);
            const buyPrice = parseFloat(document.getElementById('buyPrice').value);
            const sellPrice = parseFloat(document.getElementById('sellPrice').value);
            const feePercent = parseFloat(document.getElementById('fee').value);

            // Validate inputs
            if (isNaN(investment) || isNaN(buyPrice) || isNaN(sellPrice) || isNaN(feePercent)) {
                alert('Please enter valid numbers for all fields');
                return;
            }

            if (investment <= 0) {
                alert('Investment amount must be greater than zero');
                return;
            }

            if (buyPrice <= 0) {
                alert('Buy price must be greater than zero');
                return;
            }

            if (sellPrice <= 0) {
                alert('Sell price must be greater than zero');
                return;
            }

            if (feePercent < 0 || feePercent > 100) {
                alert('Fee percentage must be between 0 and 100');
                return;
            }

            // Calculate buy fee (applied to investment amount)
            const buyFee = investment * (feePercent / 100);
            const amountAfterBuyFee = investment - buyFee;
            
            // Calculate coins purchased with amount after buy fee
            const coinsPurchased = amountAfterBuyFee / buyPrice;
            
            // Calculate gross sale amount
            const grossSaleAmount = coinsPurchased * sellPrice;
            
            // Calculate sell fee (applied to gross sale amount)
            const sellFee = grossSaleAmount * (feePercent / 100);
            
            // Calculate net sale amount
            const netSaleAmount = grossSaleAmount - sellFee;
            
            // Calculate net profit/loss
            const netProfit = netSaleAmount - investment;
            
            // Calculate total fees
            const totalFees = buyFee + sellFee;

            // Display results with animation
            updateWithAnimation('coinsPurchased', coinsPurchased.toFixed(8));
            updateWithAnimation('buyFee', formatCurrency(buyFee));
            updateWithAnimation('grossSale', formatCurrency(grossSaleAmount));
            updateWithAnimation('sellFee', formatCurrency(sellFee));
            updateWithAnimation('netSale', formatCurrency(netSaleAmount));
            updateWithAnimation('totalFees', formatCurrency(totalFees));
            
            const netProfitElement = document.getElementById('netProfit');
            updateWithAnimation('netProfit', formatCurrency(netProfit));
            
            // Color code profit/loss
            if (netProfit > 0) {
                netProfitElement.className = 'text-2xl font-bold text-green-600';
            } else if (netProfit < 0) {
                netProfitElement.className = 'text-2xl font-bold text-red-600';
            } else {
                netProfitElement.className = 'text-2xl font-bold text-gray-600';
            }

            // Show results with smooth animation
            const resultsDiv = document.getElementById('results');
            resultsDiv.classList.add('show');
            resultsShown = true;
        }

        // Handle form submission
        document.getElementById('calcForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveFormValues();
            calculate();
        });

        // Save values when currency changes and recalculate
        document.getElementById('currency').addEventListener('change', async function() {
            saveFormValues();
            // Fetch new BTC price for the selected currency
            const currency = document.getElementById('currency').value;
            const newPrice = await fetchBTCPrice(currency);
            if (newPrice !== null) {
                document.getElementById('sellPrice').value = newPrice;
            }
            // Only recalculate if results are visible
            if (areResultsVisible()) {
                calculate();
            }
        });

        // Refresh button handler
        document.getElementById('refreshPrice').addEventListener('click', async function() {
            const currency = document.getElementById('currency').value;
            const newPrice = await fetchBTCPrice(currency);
            if (newPrice !== null) {
                document.getElementById('sellPrice').value = newPrice;
            }
            // Recalculate if results are visible
            if (areResultsVisible()) {
                calculate();
            }
        });

        // Save values and recalculate when inputs change
        ['investment', 'buyPrice', 'sellPrice', 'fee'].forEach(function(id) {
            const element = document.getElementById(id);
            element.addEventListener('change', function() {
                saveFormValues();
                // Recalculate if results are visible
                if (areResultsVisible()) {
                    calculate();
                }
            });
            // Also trigger on input event for real-time updates
            element.addEventListener('input', function() {
                // Only recalculate if results are visible
                if (areResultsVisible()) {
                    calculate();
                }
            });
        });

        // Run on page load
        window.addEventListener('load', async function() {
            initDarkMode();
            await loadFormValues();
            // Do not calculate on initial load - wait for user interaction
        });
    </script>
</body>
</html>
