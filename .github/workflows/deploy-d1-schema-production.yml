name: Deploy D1 Database Schema (Production)

on:
  push:
    branches:
      - production
    paths:
      - 'worker/schema.sql'
      - 'worker/migrations/*.sql'
      - '.github/workflows/deploy-d1-schema-production.yml'
  workflow_dispatch:

jobs:
  deploy-schema-production:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Deploy Schema to Production
        working-directory: worker/worker-news-processor
        run: |
          echo "Deploying schema to production database..."
          wrangler d1 execute crypto-news-db \
            --file=../schema.sql --env production --remote --yes
          echo "✅ Schema deployed to production database successfully"
          
          echo "Running migrations..."
          for migration in ../migrations/*.sql; do
            if [ -f "$migration" ]; then
              echo "Running migration: $(basename $migration)"
              wrangler d1 execute crypto-news-db --file="$migration" --env production --remote --yes || echo "⚠️  Migration may have already been applied: $(basename $migration)"
            fi
          done
          echo "✅ Migrations completed"

      - name: Verify Production Database
        working-directory: worker/worker-news-processor
        run: |
          echo "Verifying production database schema..."
          wrangler d1 execute crypto-news-db \
            --command "SELECT name FROM sqlite_master WHERE type='table'" \
            --env production --remote --json
          echo "Checking processing checkpoint initialization..."
          wrangler d1 execute crypto-news-db \
            --command "SELECT * FROM processing_checkpoint" \
            --env production --remote --json
