name: Deploy D1 Database Schema

on:
  push:
    branches:
      - main
    paths:
      - 'worker/schema.sql'
      - 'worker/migrations/*.sql'
      - '.github/workflows/deploy-d1-schema.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - production

jobs:
  deploy-schema:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Deploy Schema to Development
        if: >-
          (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
          github.event.inputs.environment == 'development'
        working-directory: worker/worker-news-processor
        run: |
          echo "Deploying schema to development database..."
          wrangler d1 execute crypto-news-db --file=../schema.sql --remote --yes
          echo "✅ Schema deployed to development database successfully"
          
          echo "Running migrations..."
          for migration in ../migrations/*.sql; do
            if [ -f "$migration" ]; then
              echo "Running migration: $(basename $migration)"
              wrangler d1 execute crypto-news-db --file="$migration" --yes || echo "⚠️  Migration may have already been applied: $(basename $migration)"
            fi
          done
          echo "✅ Migrations completed"

      - name: Deploy Schema to Production
        if: >-
          (github.event_name == 'push' && github.ref == 'refs/heads/production') ||
          github.event.inputs.environment == 'production'
        working-directory: worker/worker-news-processor
        run: |
          echo "Deploying schema to production database..."
          wrangler d1 execute crypto-news-db \
            --file=../schema.sql --env production --remote --yes
          echo "✅ Schema deployed to production database successfully"
          
          echo "Running migrations..."
          for migration in ../migrations/*.sql; do
            if [ -f "$migration" ]; then
              echo "Running migration: $(basename $migration)"
              wrangler d1 execute crypto-news-db --file="$migration" --env production --yes || echo "⚠️  Migration may have already been applied: $(basename $migration)"
            fi
          done
          echo "✅ Migrations completed"

      - name: Verify Development Database
        if: >-
          (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
          github.event.inputs.environment == 'development'
        working-directory: worker/worker-news-processor
        run: |
          echo "Verifying development database schema..."
          wrangler d1 execute crypto-news-db \
            --command "SELECT name FROM sqlite_master WHERE type='table'" \
            --remote --json
          echo "Checking processing checkpoint initialization..."
          wrangler d1 execute crypto-news-db \
            --command "SELECT * FROM processing_checkpoint" \
            --remote --json

      - name: Verify Production Database
        if: >-
          (github.event_name == 'push' && github.ref == 'refs/heads/production') ||
          github.event.inputs.environment == 'production'
        working-directory: worker/worker-news-processor
        run: |
          echo "Verifying production database schema..."
          wrangler d1 execute crypto-news-db \
            --command "SELECT name FROM sqlite_master WHERE type='table'" \
            --env production --remote --json
          echo "Checking processing checkpoint initialization..."
          wrangler d1 execute crypto-news-db \
            --command "SELECT * FROM processing_checkpoint" \
            --env production --remote --json
