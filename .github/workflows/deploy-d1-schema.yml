name: Deploy D1 Database Schema

on:
  push:
    branches:
      - main
    paths:
      - 'worker/schema.sql'
      - '.github/workflows/deploy-d1-schema.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - production
          - both

jobs:
  deploy-schema:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Deploy Schema to Development
        if: github.event_name == 'push' || github.event.inputs.environment == 'development' || github.event.inputs.environment == 'both'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd worker
          echo "Deploying schema to development database..."
          wrangler d1 execute crypto-news-db --file=schema.sql --yes
          echo "✅ Schema deployed to development database successfully"

      - name: Deploy Schema to Production
        if: github.event.inputs.environment == 'production' || github.event.inputs.environment == 'both'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd worker
          echo "Deploying schema to production database..."
          wrangler d1 execute crypto-news-db --file=schema.sql --env production --yes
          echo "✅ Schema deployed to production database successfully"

      - name: Verify Development Database
        if: github.event_name == 'push' || github.event.inputs.environment == 'development' || github.event.inputs.environment == 'both'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd worker
          echo "Verifying development database schema..."
          wrangler d1 execute crypto-news-db --command "SELECT name FROM sqlite_master WHERE type='table'" --json
          echo "Checking processing checkpoint initialization..."
          wrangler d1 execute crypto-news-db --command "SELECT * FROM processing_checkpoint" --json

      - name: Verify Production Database
        if: github.event.inputs.environment == 'production' || github.event.inputs.environment == 'both'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd worker
          echo "Verifying production database schema..."
          wrangler d1 execute crypto-news-db --command "SELECT name FROM sqlite_master WHERE type='table'" --env production --json
          echo "Checking processing checkpoint initialization..."
          wrangler d1 execute crypto-news-db --command "SELECT * FROM processing_checkpoint" --env production --json
